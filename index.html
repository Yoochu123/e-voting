<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Voting Ketua OSIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <!-- SheetJS (XLSX) for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --accent-color: #ff416c;
            --text-color: #333;
            --light-bg: rgba(255, 255, 255, 0.9);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('background-3038082_1280.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #2575fc;
            background-blend-mode: overlay;
            min-height: 100vh;
            color: var(--text-color);
            overflow-x: hidden;
        }
        
        .app-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .page {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        
        .page.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        .page.slide-in-left {
            animation: slideInLeft 0.5s forwards;
        }
        
        .page.slide-in-right {
            animation: slideInRight 0.5s forwards;
        }
        
        .page.slide-out-left {
            animation: slideOutLeft 0.5s forwards;
        }
        
        .page.slide-out-right {
            animation: slideOutRight 0.5s forwards;
        }
        
        .page.fade-in {
            animation: fadeIn 0.5s forwards;
        }
        
        .page.fade-out {
            animation: fadeOut 0.5s forwards;
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOutLeft {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-100px);
            }
        }
        
        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        .candidate-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: fadeInUp 0.6s ease forwards;
            opacity: 0;
        }
        
        .candidate-card:nth-child(1) { animation-delay: 0.1s; }
        .candidate-card:nth-child(2) { animation-delay: 0.2s; }
        .candidate-card:nth-child(3) { animation-delay: 0.3s; }
        .candidate-card:nth-child(4) { animation-delay: 0.4s; }
        .candidate-card:nth-child(5) { animation-delay: 0.5s; }
        .candidate-card:nth-child(6) { animation-delay: 0.6s; }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .btn-primary:before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
            z-index: -1;
        }
        
        .btn-primary:hover:before {
            transform: translateX(0);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(106, 17, 203, 0.3);
        }
        
        .btn-secondary {
            background: var(--accent-color);
            color: white;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .btn-secondary:before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
            z-index: -1;
        }
        
        .btn-secondary:hover:before {
            transform: translateX(0);
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 65, 108, 0.3);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .btn-success:before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
            z-index: -1;
        }
        
        .btn-success:hover:before {
            transform: translateX(0);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .btn-warning:before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
            z-index: -1;
        }
        
        .btn-warning:hover:before {
            transform: translateX(0);
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .btn-danger:before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
            z-index: -1;
        }
        
        .btn-danger:hover:before {
            transform: translateX(0);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .form-input {
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 10px 15px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
            outline: none;
            transform: scale(1.02);
        }
        
        .loader {
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Styling untuk preview cropper */
        .img-container-cropper {
            height: 400px;
            background-color: #f7f7f7;
            border-radius: 8px;
        }
        
        .header-gradient {
            background: linear-gradient(90deg, rgba(106, 17, 203, 0.9), rgba(37, 117, 252, 0.9));
            border-radius: 16px;
            color: white;
            animation: slideDown 0.8s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .school-logo {
            height: 80px;
            width: auto;
            margin-right: 15px;
            animation: rotateIn 1s ease;
        }
        
        @keyframes rotateIn {
            from {
                opacity: 0;
                transform: rotate(-180deg) scale(0.5);
            }
            to {
                opacity: 1;
                transform: rotate(0) scale(1);
            }
        }
        
        .footer {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            border-radius: 16px;
            margin-top: 20px;
            padding: 15px;
            text-align: center;
            color: var(--text-color);
            font-size: 14px;
            animation: fadeInUp 1s ease;
        }
        
        /* Overlay untuk background dengan opacity 50% */
        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('background-3038082_1280.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            opacity: 0.5;
            z-index: -1;
        }
        
        /* Animasi untuk elemen muncul bertahap */
        .fade-in-up {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }
        
        .fade-in-up-delay-1 {
            animation-delay: 0.2s;
        }
        
        .fade-in-up-delay-2 {
            animation-delay: 0.4s;
        }
        
        .fade-in-up-delay-3 {
            animation-delay: 0.6s;
        }
        
        /* Animasi untuk hasil voting */
        .result-bar {
            opacity: 0;
            transform: scaleX(0);
            transform-origin: left;
            animation: growWidth 1s ease forwards;
        }
        
        @keyframes growWidth {
            to {
                opacity: 1;
                transform: scaleX(1);
            }
        }
        
        /* Animasi untuk notifikasi suara */
        .vote-notification {
            animation: bounceIn 0.8s ease;
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Animasi untuk loading */
        .loading-pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.6;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- Background overlay dengan opacity 50% -->
    <div class="bg-overlay"></div>

    <div id="app-container" class="app-container container mx-auto p-4 md:p-8 max-w-7xl my-8">
        <!-- Header -->
        <header class="header-gradient shadow-lg rounded-xl p-6 mb-8 text-center">
            <div class="flex justify-center items-center mb-4">
                <h1 class="text-3xl md:text-4xl font-bold fade-in-up">Sistem E-Voting Ketua OSIS</h1>
            </div>
            <p class="text-white text-opacity-90 fade-in-up fade-in-up-delay-1">Pemilihan yang Jujur, Adil, dan Transparan</p>
        </header>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
        </div>

        <!-- Halaman Login -->
        <main id="halaman-login" class="page active">
            <div class="card p-8 max-w-md mx-auto fade-in-up">
                <div class="flex justify-center mb-6">
                </div>
                <h2 class="text-2xl font-bold text-center mb-6 fade-in-up fade-in-up-delay-1">Selamat Datang!</h2>
                <p class="text-center text-gray-600 mb-8 fade-in-up fade-in-up-delay-2">Silakan masukkan Nomor Induk Siswa (NIS) atau Kode Admin untuk melanjutkan.</p>
                <form id="login-form" class="space-y-6 fade-in-up fade-in-up-delay-3">
                    <div>
                        <label for="login-id" class="block text-sm font-medium text-gray-700">NIS / Kode Admin</label>
                        <input type="text" id="login-id" name="login-id" required class="form-input mt-1 block w-full">
                    </div>
                    <button type="submit" class="btn-primary w-full py-3 px-4 rounded-lg">
                        Masuk
                    </button>
                </form>
            </div>
        </main>

        <!-- Halaman Admin -->
        <main id="halaman-admin" class="page">
             <div class="flex flex-wrap gap-4 justify-between items-center mb-6 fade-in-up">
                <div class="flex items-center">
                    <h2 class="text-2xl font-bold">Dasbor Admin</h2>
                </div>
                <div class="flex gap-4">
                    <a href="dashboard.html" target="_blank" class="btn-primary flex items-center gap-2">
                        <i class="material-icons">visibility</i>
                        Buka Dasbor Monitor
                    </a>
                    <button id="logout-btn" class="btn-danger">Keluar</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Panel Pengaturan Pemilihan -->
                <div class="card lg:col-span-1 p-6 fade-in-up fade-in-up-delay-1">
                    <h3 class="text-xl font-bold mb-4 border-b pb-2">Pengaturan Waktu Pemilihan</h3>
                    <form id="election-time-form" class="space-y-4">
                        <div>
                            <label for="start-time" class="block text-sm font-medium">Waktu Mulai</label>
                            <input type="datetime-local" id="start-time" required class="form-input mt-1 block w-full">
                        </div>
                        <div>
                            <label for="end-time" class="block text-sm font-medium">Waktu Selesai</label>
                            <input type="datetime-local" id="end-time" required class="form-input mt-1 block w-full">
                        </div>
                        <button type="submit" class="btn-primary w-full py-2 px-4 rounded-lg">Simpan Pengaturan</button>
                    </form>
                    <div id="current-election-time" class="mt-4 text-sm text-gray-600 bg-blue-50 p-3 rounded-lg"></div>
                </div>

                <!-- Panel Upload CSV Pemilih -->
                <div class="card lg:col-span-2 p-6 fade-in-up fade-in-up-delay-2">
                    <h3 class="text-xl font-bold mb-4 border-b pb-2">Import & Reset Pemilih</h3>
                    <form id="voter-upload-form" class="space-y-4">
                        <div>
                            <label for="csv-file" class="block text-sm font-medium">File CSV Daftar Pemilih</label>
                            <input type="file" id="csv-file" accept=".csv" required class="form-input mt-1 block w-full text-sm text-gray-500">
                            <p class="text-xs text-gray-500 mt-2"><b>Format:</b> File CSV harus memiliki 2 kolom: `NIS,Nama Siswa` (pemisah bisa koma atau titik koma) di setiap baris, tanpa baris header.</p>
                        </div>
                        <div class="flex space-x-4">
                             <button type="submit" class="btn-success flex-1 py-2 px-4 rounded-lg">Upload Daftar</button>
                             <button type="button" id="clear-voters-btn" class="btn-danger flex-1 py-2 px-4 rounded-lg">Reset Pemilihan</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Panel Tambah/Edit Calon -->
            <div class="card p-6 mb-6 fade-in-up fade-in-up-delay-3">
                <h3 class="text-xl font-bold mb-4 border-b pb-2">Manajemen Kandidat</h3>
                <form id="candidate-form" class="space-y-4">
                    <input type="hidden" id="candidate-id">
                    <div>
                        <label for="candidate-name" class="block text-sm font-medium">Nama Lengkap</label>
                        <input type="text" id="candidate-name" required class="form-input mt-1 block w-full">
                    </div>
                    <div>
                        <label for="candidate-vision" class="block text-sm font-medium">Visi</label>
                        <textarea id="candidate-vision" rows="3" required class="form-input mt-1 block w-full"></textarea>
                    </div>
                    <div>
                        <label for="candidate-mission" class="block text-sm font-medium">Misi</label>
                        <textarea id="candidate-mission" rows="3" required class="form-input mt-1 block w-full"></textarea>
                    </div>
                    <div>
                        <label for="candidate-photo" class="block text-sm font-medium">Foto Kandidat (Max 2MB)</label>
                        <input type="file" id="candidate-photo" accept="image/*" class="form-input mt-1 block w-full text-sm text-gray-500">
                        <img id="photo-preview" class="mt-4 rounded-lg max-h-40 hidden" alt="Pratinjau Foto Hasil Potong">
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" id="submit-candidate-btn" class="btn-success flex-1 py-2 px-4 rounded-lg">Tambah Kandidat</button>
                        <button type="button" id="cancel-edit-btn" class="btn-secondary flex-1 py-2 px-4 rounded-lg hidden">Batal Edit</button>
                    </div>
                </form>
            </div>

            <!-- Daftar Calon & Hasil Suara -->
            <div class="card p-6 mb-6 fade-in-up">
                <h3 class="text-xl font-bold mb-4">Hasil Suara Real-time</h3>
                <div id="admin-candidate-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Calon dari JS -->
                </div>
            </div>

            <!-- Status Partisipasi Pemilih -->
            <div class="card p-6 fade-in-up fade-in-up-delay-1">
                 <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                    <div class="flex items-center">
                        <h3 class="text-xl font-bold">Status Partisipasi Pemilih</h3>
                    </div>
                    <button id="export-excel-btn" class="btn-success flex items-center gap-2">
                        <i class="material-icons">file_download</i>
                        Export ke Excel
                    </button>
                </div>
                <div id="voter-stats" class="grid grid-cols-3 gap-4 text-center mb-6 p-4 bg-gray-50 rounded-lg">
                    <!-- Statistik pemilih dari JS -->
                </div>
                <div id="voter-status-list" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Daftar status pemilih dari JS -->
                </div>
            </div>
        </main>
        
        <!-- Halaman Pemilih -->
        <main id="halaman-pemilih" class="page">
            <div class="flex justify-center mb-6 fade-in-up">
                <img src="logo.png" alt="Logo" class="h-16 w-auto">
            </div>
            <div class="text-center mb-8 fade-in-up fade-in-up-delay-1">
                <h2 class="text-2xl font-bold">Pilih Calon Ketua OSIS Pilihanmu!</h2>
                <p id="welcome-voter-message" class="text-gray-700 text-lg my-4"></p>
                <p class="text-gray-600">Pemilihan akan berakhir pada: <strong id="election-end-time-voter" class="text-red-500"></strong></p>
            </div>
            <div id="voter-candidate-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Calon dari JS -->
            </div>
        </main>

        <!-- Halaman Tunggu -->
        <main id="halaman-tunggu" class="page">
             <div class="card p-8 max-w-lg mx-auto text-center fade-in-up">
                <div class="flex justify-center mb-4">
                    <img src="logo.png" alt="Logo" class="h-16 w-auto">
                </div>
                <h2 class="text-2xl font-bold text-yellow-500 mb-4">Pemilihan Belum Dibuka atau Sudah Ditutup</h2>
                <p class="text-gray-600 mb-2">Waktu pemilihan yang telah ditetapkan:</p>
                <p id="wait-time-info" class="font-semibold text-blue-600"></p>
                <p class="mt-6 text-gray-500">Silakan kembali lagi saat waktu pemilihan sudah dimulai atau lihat hasil setelah pemilihan selesai.</p>
                 <button id="view-results-btn" class="btn-primary mt-6 w-full py-3 px-4 rounded-lg">Lihat Hasil Akhir</button>
            </div>
        </main>

        <!-- Halaman Hasil -->
        <main id="halaman-hasil" class="page">
             <div class="card p-8 fade-in-up">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center">
                        <img src="logo.png" alt="Logo" class="h-10 w-auto mr-3">
                        <h2 class="text-2xl font-bold">Hasil Akhir Pemilihan</h2>
                    </div>
                    <button id="back-to-login-btn" class="btn-secondary">Kembali ke Login</button>
                </div>
                <div id="results-container" class="space-y-4">
                    <!-- Hasil dari JS -->
                </div>
            </div>
        </main>

        <!-- Halaman Terima Kasih -->
        <main id="halaman-terima-kasih" class="page">
            <div class="card p-8 max-w-lg mx-auto text-center vote-notification">
                <div class="flex justify-center mb-4">
                    <img src="logo.png" alt="Logo" class="h-16 w-auto">
                </div>
                <i class="material-icons text-green-500 text-6xl mb-4">check_circle</i>
                <h2 class="text-2xl font-bold text-green-600 mt-4 mb-2">Terima Kasih!</h2>
                <p class="text-gray-600">Suara Anda telah berhasil direkam. Partisipasi Anda sangat berarti untuk kemajuan sekolah kita.</p>
                <button id="view-results-after-vote-btn" class="btn-primary mt-6 w-full py-3 px-4 rounded-lg">Lihat Hasil Sementara</button>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
    <div class="flex justify-center items-center mb-2">
        <img src="logo.png" alt="Logo" class="h-8 w-auto mr-2">
        <p>Â© 2025. Sistem E-Voting Ketua OSIS</p>
    </div>
    <p class="text-center text-sm text-gray-500">
        created by: aldi_wok.
    </p>
</footer>

    <!-- Cropper.js Modal -->
    <div id="crop-modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-[100] p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg flex flex-col">
            <h3 class="text-xl font-bold mb-4">Sesuaikan Foto Kandidat</h3>
            <div class="mb-4 img-container-cropper">
                <img id="image-to-crop" class="max-w-full" src="" alt="Gambar untuk dipotong">
            </div>
            <div class="flex justify-end space-x-4 mt-auto">
                <button id="cancel-crop-btn" type="button" class="btn-secondary">Batal</button>
                <button id="crop-and-save-btn" type="button" class="btn-primary">Potong & Simpan</button>
            </div>
        </div>
    </div>

    <!-- Cropper.js Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script type="module">
        // Import fungsi Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, runTransaction, query, getDocs, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBhLIvfErc0oDs2Fd3Ojqxstq7cxoQqDck",
            authDomain: "osis-a58ba.firebaseapp.com",
            projectId: "osis-a58ba",
            storageBucket: "osis-a58ba.firebasestorage.app",
            messagingSenderId: "459759642871",
            appId: "1:459759642871:web:19481954e75ae15c408bf2"
        };
        
        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // === State Management ===
        let currentUser = null;
        let electionSettings = { startTime: null, endTime: null };
        const ADMIN_CODE = "admin";
        let cropper = null;
        let croppedImageDataUrl = null; // Menyimpan data gambar yang sudah di-crop
        let currentPage = 'halaman-login'; // Track current page for animation direction

        // === DOM Elements ===
        const pages = document.querySelectorAll('.page');
        const loginForm = document.getElementById('login-form');
        const loginIdInput = document.getElementById('login-id');
        const loadingIndicator = document.getElementById('loading-indicator');
        const candidateForm = document.getElementById('candidate-form');
        const electionTimeForm = document.getElementById('election-time-form');
        const voterUploadForm = document.getElementById('voter-upload-form');
        const csvFileInput = document.getElementById('csv-file');
        const clearVotersBtn = document.getElementById('clear-voters-btn');
        const cropModal = document.getElementById('crop-modal-container');
        const imageToCrop = document.getElementById('image-to-crop');
        const cropAndSaveBtn = document.getElementById('crop-and-save-btn');
        const cancelCropBtn = document.getElementById('cancel-crop-btn');
        const photoPreview = document.getElementById('photo-preview');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        
        // === Helper Functions ===
        const showPage = (pageId) => {
            // Determine animation direction based on current and target page
            const pageOrder = ['halaman-login', 'halaman-admin', 'halaman-pemilih', 'halaman-tunggu', 'halaman-hasil', 'halaman-terima-kasih'];
            const currentIndex = pageOrder.indexOf(currentPage);
            const targetIndex = pageOrder.indexOf(pageId);
            
            // Hide current page with animation
            const currentPageElement = document.getElementById(currentPage);
            if (currentPageElement) {
                if (targetIndex > currentIndex) {
                    currentPageElement.classList.add('slide-out-left');
                } else {
                    currentPageElement.classList.add('slide-out-right');
                }
            }
            
            // Show target page with animation after a short delay
            setTimeout(() => {
                pages.forEach(page => {
                    page.classList.remove('active', 'slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
                });
                
                const targetPage = document.getElementById(pageId);
                targetPage.classList.add('active');
                
                // Add animation class based on direction
                if (targetIndex > currentIndex) {
                    targetPage.classList.add('slide-in-right');
                } else {
                    targetPage.classList.add('slide-in-left');
                }
                
                // Reset candidate card animations
                const candidateCards = targetPage.querySelectorAll('.candidate-card');
                candidateCards.forEach(card => {
                    card.style.animation = 'none';
                    setTimeout(() => {
                        card.style.animation = '';
                    }, 10);
                });
                
                // Reset fade-in-up animations
                const fadeElements = targetPage.querySelectorAll('.fade-in-up');
                fadeElements.forEach(el => {
                    el.style.animation = 'none';
                    setTimeout(() => {
                        el.style.animation = '';
                    }, 10);
                });
                
                currentPage = pageId;
            }, 300);
        };

        const showLoading = (isLoading) => {
            loadingIndicator.classList.toggle('hidden', !isLoading);
        };

        const showAlert = (title, text, icon) => {
            Swal.fire({ 
                title, 
                text, 
                icon, 
                confirmButtonColor: '#6a11cb',
                showClass: {
                    popup: 'animate__animated animate__fadeInDown'
                },
                hideClass: {
                    popup: 'animate__animated animate__fadeOutUp'
                }
            });
        };
        
        const formatDate = (date) => {
             if (!date) return 'Belum diatur';
             return new Date(date).toLocaleString('id-ID', {
                dateStyle: 'full',
                timeStyle: 'short'
            });
        };

        // === Firebase Logic ===
        
        // Listener untuk pengaturan pemilihan
        const listenToElectionSettings = () => {
            const configRef = doc(db, 'config', 'election');
            onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    electionSettings.startTime = data.startTime?.toDate();
                    electionSettings.endTime = data.endTime?.toDate();
                } else {
                    electionSettings.startTime = null;
                    electionSettings.endTime = null;
                }
                updateElectionTimeDisplay();
            });
        };

        // Memeriksa status pemilihan
        const checkElectionStatus = () => {
            const now = new Date();
            if (!electionSettings.startTime || !electionSettings.endTime) {
                return 'NOT_CONFIGURED';
            }
            if (now < electionSettings.startTime) {
                return 'NOT_STARTED';
            }
            if (now > electionSettings.endTime) {
                return 'ENDED';
            }
            return 'ACTIVE';
        };

        const updateElectionTimeDisplay = () => {
            const currentElectionTimeDiv = document.getElementById('current-election-time');
            const waitTimeInfoP = document.getElementById('wait-time-info');
            const electionEndTimeVoter = document.getElementById('election-end-time-voter');
            
            if (electionSettings.startTime && electionSettings.endTime) {
                const formattedStart = formatDate(electionSettings.startTime);
                const formattedEnd = formatDate(electionSettings.endTime);
                
                if (currentElectionTimeDiv) {
                    currentElectionTimeDiv.innerHTML = `
                        <p><strong>Mulai:</strong> ${formattedStart}</p>
                        <p><strong>Selesai:</strong> ${formattedEnd}</p>
                    `;
                }
                
                if (waitTimeInfoP) {
                    waitTimeInfoP.textContent = `${formattedStart} - ${formattedEnd}`;
                }
                
                if (electionEndTimeVoter) {
                    electionEndTimeVoter.textContent = formattedEnd;
                }
            } else {
                if (currentElectionTimeDiv) {
                    currentElectionTimeDiv.textContent = 'Belum diatur';
                }
                
                if (waitTimeInfoP) {
                    waitTimeInfoP.textContent = 'Belum diatur';
                }
                
                if (electionEndTimeVoter) {
                    electionEndTimeVoter.textContent = 'Belum diatur';
                }
            }
        };

        const renderAdminCandidatesAndResults = () => {
            const candidatesCollection = collection(db, 'candidates');
            onSnapshot(query(candidatesCollection), (snapshot) => {
                const list = document.getElementById('admin-candidate-list');
                list.innerHTML = '';
                if (snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-500 col-span-full text-center">Belum ada kandidat yang ditambahkan.</p>';
                    return;
                }
                snapshot.forEach(docSnap => {
                    const candidate = { id: docSnap.id, ...docSnap.data() };
                    const totalVotes = candidate.votes || 0;
                    const card = `
                        <div class="card p-4">
                            <img src="${candidate.photoBase64}" alt="${candidate.name}" class="w-full aspect-square object-cover rounded-md mb-4">
                            <h4 class="font-bold text-lg">${candidate.name}</h4>
                            <p class="font-bold text-2xl text-blue-600 my-2">${totalVotes} Suara</p>
                            <div class="flex space-x-2 mt-4">
                                <button data-id="${candidate.id}" class="edit-btn flex-1 btn-warning text-sm">Edit</button>
                                <button data-id="${candidate.id}" class="delete-btn flex-1 btn-danger text-sm">Hapus</button>
                            </div>
                        </div>
                    `;
                    list.innerHTML += card;
                });
            });
        };
        
        const renderVoterStatus = async () => {
            const statsContainer = document.getElementById('voter-stats');
            const listContainer = document.getElementById('voter-status-list');
            statsContainer.innerHTML = ''; // Clear previous
            listContainer.innerHTML = '<p class="text-center text-gray-500">Memuat data pemilih...</p>'; // Loading state

            try {
                const [allowedVotersSnap, votersSnap] = await Promise.all([
                    getDocs(collection(db, 'allowedVoters')),
                    getDocs(collection(db, 'voters'))
                ]);

                const votedSet = new Set();
                votersSnap.forEach(doc => {
                    if (doc.data().hasVoted) {
                        votedSet.add(doc.id);
                    }
                });

                const totalAllowedVoters = allowedVotersSnap.size;
                const votedCount = votedSet.size;
                const participation = totalAllowedVoters > 0 ? ((votedCount / totalAllowedVoters) * 100).toFixed(1) : 0;
                
                // Render stats
                statsContainer.innerHTML = `
                    <div><p class="text-gray-500 text-sm md:text-base">Total Pemilih</p><p class="text-2xl font-bold">${totalAllowedVoters}</p></div>
                    <div><p class="text-gray-500 text-sm md:text-base">Sudah Memilih</p><p class="text-2xl font-bold text-green-600">${votedCount}</p></div>
                    <div><p class="text-gray-500 text-sm md:text-base">Partisipasi</p><p class="text-2xl font-bold text-blue-600">${participation}%</p></div>
                `;

                // Render list
                listContainer.innerHTML = '';
                if (totalAllowedVoters === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500">Daftar pemilih belum diunggah.</p>';
                    return;
                }

                let voterListHtml = '';
                const sortedAllowedVoters = [];
                 allowedVotersSnap.forEach(doc => sortedAllowedVoters.push({id: doc.id, ...doc.data()}));
                 sortedAllowedVoters.sort((a, b) => a.id.localeCompare(b.id)); // Sort by NIS

                sortedAllowedVoters.forEach(voter => {
                    const hasVoted = votedSet.has(voter.id);
                    voterListHtml += `
                        <div class="flex justify-between items-center p-3 rounded-lg ${hasVoted ? 'bg-green-50' : 'bg-gray-50'}">
                            <span class="font-medium text-gray-700">${voter.id} - ${voter.nama}</span>
                            ${hasVoted 
                                ? `<span class="flex items-center text-xs md:text-sm font-semibold text-green-700 bg-green-200 px-3 py-1 rounded-full">
                                    <i class="material-icons w-4 h-4 mr-1 hidden md:block">check</i>
                                    Sudah Memilih
                                   </span>` 
                                : `<span class="text-xs md:text-sm font-semibold text-gray-500 bg-gray-200 px-3 py-1 rounded-full">Belum Memilih</span>`
                            }
                        </div>
                    `;
                });
                listContainer.innerHTML = voterListHtml;

            } catch (error) {
                console.error("Error rendering voter status:", error);
                listContainer.innerHTML = '<p class="text-center text-red-500">Gagal memuat data.</p>';
            }
        };

        const renderVoterCandidates = async () => {
            const list = document.getElementById('voter-candidate-list');
            list.innerHTML = '';
            try {
                const snapshot = await getDocs(query(collection(db, 'candidates')));
                 if (snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-500 col-span-full text-center">Belum ada kandidat yang tersedia.</p>';
                    return;
                }
                snapshot.forEach(docSnap => {
                    const candidate = { id: docSnap.id, ...docSnap.data() };
                    const card = `
                    <div class="card candidate-card overflow-hidden">
                        <img src="${candidate.photoBase64}" alt="${candidate.name}" class="w-full aspect-square object-cover">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold mb-2">${candidate.name}</h3>
                            <div class="mb-4">
                                <h4 class="font-semibold text-blue-600">Visi:</h4>
                                <p class="text-gray-600 text-sm">${candidate.vision}</p>
                            </div>
                            <div class="mb-6">
                                <h4 class="font-semibold text-blue-600">Misi:</h4>
                                <p class="text-gray-600 text-sm">${candidate.mission}</p>
                            </div>
                            <button data-id="${candidate.id}" data-name="${candidate.name}" class="vote-btn btn-primary w-full py-3 px-4 rounded-lg">
                                Pilih ${candidate.name}
                            </button>
                        </div>
                    </div>
                    `;
                    list.innerHTML += card;
                });
            } catch (error) {
                console.error("Error fetching candidates: ", error);
                showAlert('Error', 'Gagal memuat kandidat.', 'error');
            }
        };

        const renderResults = async (containerId) => {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            showLoading(true);
            try {
                const snapshot = await getDocs(query(collection(db, 'candidates')));
                let candidates = [];
                let totalVotes = 0;
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    candidates.push({ id: docSnap.id, ...data });
                    totalVotes += (data.votes || 0);
                });
                
                candidates.sort((a, b) => (b.votes || 0) - (a.votes || 0));

                if (candidates.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center">Belum ada hasil untuk ditampilkan.</p>';
                    showLoading(false);
                    return;
                }
                
                candidates.forEach((candidate, index) => {
                    const votes = candidate.votes || 0;
                    const percentage = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(1) : 0;
                    const isWinner = index === 0 && votes > 0;
                    const resultBar = `
                    <div class="p-4 rounded-lg ${isWinner ? 'bg-green-50 border-2 border-green-400' : 'bg-gray-50 border'} result-bar" style="animation-delay: ${index * 0.1}s">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center">
                                <span class="font-bold text-lg ${isWinner ? 'text-green-600' : 'text-gray-800'}">${candidate.name}</span>
                                ${isWinner ? '<span class="ml-2 text-xs font-bold bg-green-200 text-green-800 px-2 py-1 rounded-full">PEMENANG</span>' : ''}
                            </div>
                            <span class="font-bold text-lg ${isWinner ? 'text-green-600' : 'text-blue-600'}">${votes} Suara (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-blue-500 h-4 rounded-full ${isWinner ? '!bg-green-500' : ''}" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                    `;
                    container.innerHTML += resultBar;
                });
                 container.innerHTML += `<p class="text-center font-bold mt-6">Total Suara Masuk: ${totalVotes}</p>`;

            } catch (error) {
                console.error("Error fetching results: ", error);
                showAlert('Error', 'Gagal memuat hasil.', 'error');
            } finally {
                showLoading(false);
            }
        };

        // === Event Listeners ===
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = loginIdInput.value.trim();
            if (!id) {
                showAlert('Input Kosong', 'Harap masukkan NIS atau Kode Admin.', 'warning');
                return;
            }

            showLoading(true);

            if (id === ADMIN_CODE) {
                currentUser = { id: 'admin', role: 'admin' };
                showPage('halaman-admin');
                renderAdminCandidatesAndResults();
                renderVoterStatus();
            } else {
                
                try {
                    const allowedVoterRef = doc(db, 'allowedVoters', id);
                    const allowedVoterSnap = await getDoc(allowedVoterRef);

                    if (!allowedVoterSnap.exists()) {
                        showAlert('NIS Tidak Terdaftar', 'NIS Anda tidak terdaftar dalam daftar pemilih yang sah.', 'error');
                        showLoading(false);
                        return;
                    }

                    const studentName = allowedVoterSnap.data().nama || 'Siswa';
                    currentUser = { id, role: 'voter', name: studentName };

                    const voterRef = doc(db, 'voters', currentUser.id);
                    const voterSnap = await getDoc(voterRef);

                    if (voterSnap.exists() && voterSnap.data().hasVoted) {
                        showAlert('Sudah Memilih', 'Anda sudah menggunakan hak suara Anda.', 'info');
                        showPage('halaman-terima-kasih');
                    } else {
                        const status = checkElectionStatus();
                        if (status === 'ACTIVE') {
                            document.getElementById('welcome-voter-message').textContent = `Selamat datang, ${currentUser.name}! Mari berperan aktif dalam kemajuan sekolah, silakan pilih sesuai dengan apa yang kamu cita-citakan dan tujuanmu.`;
                            await renderVoterCandidates();
                            showPage('halaman-pemilih');
                        } else {
                            showPage('halaman-tunggu');
                        }
                    }
                } catch (error) {
                    console.error("Login error:", error);
                    showAlert('Error', 'Terjadi kesalahan saat verifikasi data.', 'error');
                }
            }
            showLoading(false);
        });
        
        voterUploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const file = csvFileInput.files[0];

            if (!file) {
                showAlert('Tidak Ada File', 'Silakan pilih file CSV untuk diunggah.', 'warning');
                return;
            }
            showLoading(true);
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const csvText = event.target.result;
                    const lines = csvText.split(/\r?\n/).filter(line => line.trim());
                    
                    if (lines.length === 0) {
                        showAlert('File Kosong', 'File CSV tidak berisi data yang valid.', 'warning');
                        showLoading(false);
                        return;
                    }

                    const votersList = lines.map(line => {
                        const [nis, ...namaParts] = line.split(/[,;]/); // Handles both comma and semicolon
                        const nama = namaParts.join(',').trim();
                        return { nis: nis.trim(), nama };
                    }).filter(v => v.nis && v.nama);

                    if(votersList.length === 0){
                        showAlert('Format Salah', 'Pastikan format CSV adalah NIS,Nama Siswa (atau NIS;Nama Siswa) dan file tidak kosong.', 'error');
                        showLoading(false);
                        return;
                    }

                    const existingVotersSnapshot = await getDocs(collection(db, 'allowedVoters'));
                    const deleteBatch = writeBatch(db);
                    existingVotersSnapshot.forEach((doc) => {
                        deleteBatch.delete(doc.ref);
                    });
                    await deleteBatch.commit();
                    
                    const addBatch = writeBatch(db);
                    votersList.forEach(voter => {
                        const voterRef = doc(db, 'allowedVoters', voter.nis);
                        addBatch.set(voterRef, { nama: voter.nama });
                    });
                    await addBatch.commit();

                    showAlert('Sukses', `${votersList.length} pemilih berhasil diimpor. Daftar pemilih sebelumnya telah diganti.`, 'success');
                    renderVoterStatus();

                } catch (error) {
                    console.error("Error importing voters: ", error);
                    showAlert('Error', 'Terjadi kesalahan saat mengimpor data.', 'error');
                } finally {
                    showLoading(false);
                    voterUploadForm.reset();
                }
            };
            reader.readAsText(file);
        });

        clearVotersBtn.addEventListener('click', () => {
            Swal.fire({
                title: 'Reset Seluruh Data Pemilihan?',
                text: "Aksi ini akan MENGHAPUS SEMUA daftar pemilih (dari CSV) DAN data siapa saja yang sudah memilih. Jumlah suara pada kandidat JUGA akan direset ke 0. Aksi ini tidak bisa dibatalkan.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Reset Semuanya!',
                cancelButtonText: 'Batal'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading(true);
                    try {
                        const [allowedVotersSnap, votersSnap, candidatesSnap] = await Promise.all([
                            getDocs(collection(db, 'allowedVoters')),
                            getDocs(collection(db, 'voters')),
                            getDocs(collection(db, 'candidates'))
                        ]);

                        const batch = writeBatch(db);
                        allowedVotersSnap.forEach(doc => batch.delete(doc.ref));
                        votersSnap.forEach(doc => batch.delete(doc.ref));
                        candidatesSnap.forEach(doc => {
                            batch.update(doc.ref, { votes: 0 });
                        });

                        await batch.commit();
                        showAlert('Berhasil!', 'Seluruh data pemilihan (pemilih, suara, dan status) telah berhasil direset.', 'success');
                        renderVoterStatus(); 

                    } catch (error) {
                        console.error("Error resetting election data: ", error);
                        showAlert('Error!', 'Gagal mereset data pemilihan.', 'error');
                    } finally {
                        showLoading(false);
                    }
                }
            });
        });

        const exportToExcel = async () => {
            showLoading(true);
            try {
                const [allowedVotersSnap, votersSnap] = await Promise.all([
                    getDocs(collection(db, 'allowedVoters')),
                    getDocs(collection(db, 'voters'))
                ]);

                if (allowedVotersSnap.empty) {
                    showAlert('Tidak Ada Data', 'Daftar pemilih kosong, tidak ada data untuk diekspor.', 'info');
                    return;
                }

                const votedSet = new Set();
                votersSnap.forEach(doc => {
                    if (doc.data().hasVoted) {
                        votedSet.add(doc.id);
                    }
                });

                const exportData = [];
                allowedVotersSnap.forEach(doc => {
                    exportData.push({
                        'NIS': doc.id,
                        'Nama Siswa': doc.data().nama,
                        'Status': votedSet.has(doc.id) ? 'Sudah Memilih' : 'Belum Memilih'
                    });
                });
                
                exportData.sort((a, b) => a['NIS'].localeCompare(b['NIS']));

                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Partisipasi Pemilih");
                
                // Auto-fit columns
                const objectMaxLength = [];
                exportData.forEach(item => {
                    Object.keys(item).forEach((key, i) => {
                        const len = item[key] ? item[key].toString().length : 0;
                        if (!objectMaxLength[i] || objectMaxLength[i] < len) {
                            objectMaxLength[i] = len;
                        }
                    });
                });
                 worksheet["!cols"] = objectMaxLength.map(w => ({ wch: w + 2 }));


                XLSX.writeFile(workbook, "Laporan_Partisipasi_Pemilih.xlsx");

            } catch (error) {
                console.error("Error exporting to Excel:", error);
                showAlert('Error', 'Gagal mengekspor data ke Excel.', 'error');
            } finally {
                showLoading(false);
            }
        };

        exportExcelBtn.addEventListener('click', exportToExcel);


        // Event listener untuk admin
        document.getElementById('logout-btn').addEventListener('click', () => {
            currentUser = null;
            loginIdInput.value = '';
            showPage('halaman-login');
        });
        
        document.getElementById('back-to-login-btn').addEventListener('click', () => {
            currentUser = null;
            loginIdInput.value = '';
            showPage('halaman-login');
        });
        
        document.getElementById('view-results-btn').addEventListener('click', () => {
            renderResults('results-container');
            showPage('halaman-hasil');
        });
        
        document.getElementById('view-results-after-vote-btn').addEventListener('click', () => {
            renderResults('results-container');
            showPage('halaman-hasil');
        });

        electionTimeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const startTime = new Date(document.getElementById('start-time').value);
            const endTime = new Date(document.getElementById('end-time').value);

            if (isNaN(startTime.getTime()) || isNaN(endTime.getTime()) || startTime >= endTime) {
                showAlert('Input Tidak Valid', 'Waktu mulai dan selesai tidak valid.', 'error');
                return;
            }

            showLoading(true);
            try {
                const configRef = doc(db, 'config', 'election');
                await setDoc(configRef, { startTime, endTime });
                showAlert('Sukses', 'Jadwal pemilihan berhasil diperbarui.', 'success');
            } catch (error) {
                console.error("Error setting election time: ", error);
                showAlert('Error', 'Gagal menyimpan jadwal.', 'error');
            } finally {
                showLoading(false);
            }
        });

        // Event listener untuk input file foto -> Buka Cropper
        document.getElementById('candidate-photo').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) { return; }

            if (file.size > 1024 * 1024 * 2) { // 2MB limit
                showAlert('Ukuran File Terlalu Besar', 'Ukuran foto tidak boleh melebihi 2MB.', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                imageToCrop.src = event.target.result;
                cropModal.classList.remove('hidden');
                cropModal.classList.add('flex');
                
                if (cropper) { cropper.destroy(); }

                cropper = new Cropper(imageToCrop, {
                    aspectRatio: 1 / 1,
                    viewMode: 1,
                    background: false,
                });
            };
            reader.readAsDataURL(file);
        });

        cancelCropBtn.addEventListener('click', () => {
            cropModal.classList.add('hidden');
            cropModal.classList.remove('flex');
            if (cropper) { cropper.destroy(); }
            document.getElementById('candidate-photo').value = '';
        });

        cropAndSaveBtn.addEventListener('click', () => {
            if (cropper) {
                const canvas = cropper.getCroppedCanvas({
                    width: 500, height: 500, imageSmoothingQuality: 'high',
                });
                croppedImageDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                photoPreview.src = croppedImageDataUrl;
                photoPreview.classList.remove('hidden');
                
                cropModal.classList.add('hidden');
                cropModal.classList.remove('flex');
                cropper.destroy();
            }
        });

        candidateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const candidateId = document.getElementById('candidate-id').value;
            const name = document.getElementById('candidate-name').value;
            const vision = document.getElementById('candidate-vision').value;
            const mission = document.getElementById('candidate-mission').value;

            if (!name || !vision || !mission) {
                showAlert('Data Tidak Lengkap', 'Nama, visi, dan misi harus diisi.', 'warning');
                return;
            }
            
            if (!candidateId && !croppedImageDataUrl) { 
                showAlert('Foto Wajib', 'Foto kandidat harus diunggah dan dipotong.', 'warning');
                return;
            }

            showLoading(true);

            try {
                let photoBase64;
                if (croppedImageDataUrl) {
                    photoBase64 = croppedImageDataUrl;
                } else {
                    photoBase64 = photoPreview.src;
                }
                const candidateData = { name, vision, mission, photoBase64 };
                if (candidateId) {
                    const candidateRef = doc(db, 'candidates', candidateId);
                    await updateDoc(candidateRef, candidateData);
                    showAlert('Sukses', 'Data kandidat berhasil diperbarui.', 'success');
                } else {
                    candidateData.votes = 0;
                    const newCandidateRef = doc(collection(db, 'candidates'));
                    await setDoc(newCandidateRef, candidateData);
                    showAlert('Sukses', 'Kandidat baru berhasil ditambahkan.', 'success');
                }
                
                candidateForm.reset();
                photoPreview.classList.add('hidden');
                photoPreview.src = '';
                croppedImageDataUrl = null;
                document.getElementById('candidate-id').value = '';
                document.getElementById('submit-candidate-btn').textContent = 'Tambah Kandidat';
                document.getElementById('cancel-edit-btn').classList.add('hidden');

            } catch (error) {
                console.error("Error saving candidate: ", error);
                showAlert('Error', 'Gagal menyimpan data kandidat.', 'error');
            } finally {
                showLoading(false);
            }
        });

        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
             candidateForm.reset();
             photoPreview.classList.add('hidden');
             photoPreview.src = '';
             croppedImageDataUrl = null;
             document.getElementById('candidate-id').value = '';
             document.getElementById('submit-candidate-btn').textContent = 'Tambah Kandidat';
             document.getElementById('cancel-edit-btn').classList.add('hidden');
        });

        // Event delegation for dynamic buttons
        document.body.addEventListener('click', async (e) => {
            if (e.target.closest('.edit-btn')) {
                const id = e.target.closest('.edit-btn').dataset.id;
                showLoading(true);
                try {
                    const candidateRef = doc(db, 'candidates', id);
                    const docSnap = await getDoc(candidateRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('candidate-id').value = id;
                        document.getElementById('candidate-name').value = data.name;
                        document.getElementById('candidate-vision').value = data.vision;
                        document.getElementById('candidate-mission').value = data.mission;
                        photoPreview.src = data.photoBase64;
                        photoPreview.classList.remove('hidden');
                        croppedImageDataUrl = null; // Reset cropper state on edit
                        document.getElementById('submit-candidate-btn').textContent = 'Update Kandidat';
                        document.getElementById('cancel-edit-btn').classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Error fetching candidate for edit:", error);
                    showAlert('Error', 'Gagal memuat data kandidat.', 'error');
                } finally {
                    showLoading(false);
                }
            }
            
            if (e.target.closest('.delete-btn')) {
                const id = e.target.closest('.delete-btn').dataset.id;
                Swal.fire({
                    title: 'Hapus Kandidat?',
                    text: "Apakah Anda yakin ingin menghapus kandidat ini? Aksi ini tidak bisa dibatalkan.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Ya, Hapus!',
                    cancelButtonText: 'Batal'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        showLoading(true);
                        try {
                            await deleteDoc(doc(db, 'candidates', id));
                            showAlert('Berhasil!', 'Kandidat berhasil dihapus.', 'success');
                        } catch (error) {
                            console.error("Error deleting candidate:", error);
                            showAlert('Error!', 'Gagal menghapus kandidat.', 'error');
                        } finally {
                            showLoading(false);
                        }
                    }
                });
            }
            
            if (e.target.closest('.vote-btn')) {
                const candidateId = e.target.closest('.vote-btn').dataset.id;
                const candidateName = e.target.closest('.vote-btn').dataset.name;
                
                Swal.fire({
                    title: 'Konfirmasi Pilihan',
                    text: `Apakah Anda yakin memilih ${candidateName}?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#6a11cb',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ya, Pilih!',
                    cancelButtonText: 'Batal'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        showLoading(true);
                        try {
                            // Update candidate votes
                            const candidateRef = doc(db, 'candidates', candidateId);
                            await runTransaction(db, async (transaction) => {
                                const candidateDoc = await transaction.get(candidateRef);
                                if (!candidateDoc.exists()) {
                                    throw new Error("Kandidat tidak ditemukan!");
                                }
                                
                                const newVotes = (candidateDoc.data().votes || 0) + 1;
                                transaction.update(candidateRef, { votes: newVotes });
                                
                                // Mark voter as having voted
                                const voterRef = doc(db, 'voters', currentUser.id);
                                transaction.set(voterRef, { hasVoted: true });
                            });
                            
                            showAlert('Berhasil!', `Terima kasih telah memilih ${candidateName}!`, 'success');
                            showPage('halaman-terima-kasih');
                        } catch (error) {
                            console.error("Error voting:", error);
                            showAlert('Error', 'Gagal menyimpan pilihan Anda.', 'error');
                        } finally {
                            showLoading(false);
                        }
                    }
                });
            }
        });

        // Initialize the app
        listenToElectionSettings();
    </script>
</body>
</html>