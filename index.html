<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Voting Ketua OSIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <!-- SheetJS (XLSX) for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .candidate-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .candidate-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        /* Styling untuk preview cropper */
        .img-container-cropper {
            height: 400px;
            background-color: #f7f7f7;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Header -->
        <header class="bg-white shadow-md rounded-lg p-6 mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600">Sistem E-Voting Ketua OSIS</h1>
            <p class="text-gray-500 mt-2">Pemilihan yang Jujur, Adil, dan Transparan</p>
        </header>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
        </div>

        <!-- Halaman Login -->
        <main id="halaman-login" class="page active">
            <div class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
                <h2 class="text-2xl font-bold text-center mb-6">Selamat Datang!</h2>
                <p class="text-center text-gray-600 mb-8">Silakan masukkan Nomor Induk Siswa (NIS) atau Kode Admin untuk melanjutkan.</p>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-id" class="block text-sm font-medium text-gray-700">NIS / Kode Admin</label>
                        <input type="text" id="login-id" name="login-id" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300">
                        Masuk
                    </button>
                </form>
            </div>
        </main>

        <!-- Halaman Admin -->
        <main id="halaman-admin" class="page">
             <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Dasbor Admin</h2>
                <div class="flex gap-4">
                    <a href="dashboard.html" target="_blank" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                          <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                        </svg>
                        Buka Dasbor Monitor
                    </a>
                    <button id="logout-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Keluar</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Panel Pengaturan Pemilihan -->
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4 border-b pb-2">Pengaturan Waktu Pemilihan</h3>
                    <form id="election-time-form" class="space-y-4">
                        <div>
                            <label for="start-time" class="block text-sm font-medium">Waktu Mulai</label>
                            <input type="datetime-local" id="start-time" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="end-time" class="block text-sm font-medium">Waktu Selesai</label>
                            <input type="datetime-local" id="end-time" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Simpan Pengaturan</button>
                    </form>
                    <div id="current-election-time" class="mt-4 text-sm text-gray-600 bg-blue-50 p-3 rounded-lg"></div>
                </div>

                <!-- Panel Upload CSV Pemilih -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4 border-b pb-2">Import & Reset Pemilih</h3>
                    <form id="voter-upload-form" class="space-y-4">
                        <div>
                            <label for="csv-file" class="block text-sm font-medium">File CSV Daftar Pemilih</label>
                            <input type="file" id="csv-file" accept=".csv" required class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            <p class="text-xs text-gray-500 mt-2"><b>Format:</b> File CSV harus memiliki 2 kolom: `NIS,Nama Siswa` (pemisah bisa koma atau titik koma) di setiap baris, tanpa baris header.</p>
                        </div>
                        <div class="flex space-x-4">
                             <button type="submit" class="flex-1 bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors">Upload Daftar</button>
                             <button type="button" id="clear-voters-btn" class="flex-1 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">Reset Pemilihan</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Panel Tambah/Edit Calon -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <h3 class="text-xl font-bold mb-4 border-b pb-2">Manajemen Kandidat</h3>
                <form id="candidate-form" class="space-y-4">
                    <input type="hidden" id="candidate-id">
                    <div>
                        <label for="candidate-name" class="block text-sm font-medium">Nama Lengkap</label>
                        <input type="text" id="candidate-name" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="candidate-vision" class="block text-sm font-medium">Visi</label>
                        <textarea id="candidate-vision" rows="3" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="candidate-mission" class="block text-sm font-medium">Misi</label>
                        <textarea id="candidate-mission" rows="3" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="candidate-photo" class="block text-sm font-medium">Foto Kandidat (Max 2MB)</label>
                        <input type="file" id="candidate-photo" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <img id="photo-preview" class="mt-4 rounded-lg max-h-40 hidden" alt="Pratinjau Foto Hasil Potong">
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" id="submit-candidate-btn" class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Tambah Kandidat</button>
                        <button type="button" id="cancel-edit-btn" class="flex-1 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors hidden">Batal Edit</button>
                    </div>
                </form>
            </div>

            <!-- Daftar Calon & Hasil Suara -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <h3 class="text-xl font-bold mb-4">Hasil Suara Real-time</h3>
                <div id="admin-candidate-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Calon dari JS -->
                </div>
            </div>

            <!-- Status Partisipasi Pemilih -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                 <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Status Partisipasi Pemilih</h3>
                    <button id="export-excel-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M2 3a1 1 0 011-1h14a1 1 0 011 1v14a1 1 0 01-1 1H3a1 1 0 01-1-1V3zm2 2v10h12V5H4zm2 2h2v2H6V7zm0 4h2v2H6v-2zm4-4h4v2h-4V7zm0 4h4v2h-4v-2z" />
                        </svg>
                        Export ke Excel
                    </button>
                </div>
                <div id="voter-stats" class="grid grid-cols-3 gap-4 text-center mb-6 p-4 bg-gray-50 rounded-lg">
                    <!-- Statistik pemilih dari JS -->
                </div>
                <div id="voter-status-list" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Daftar status pemilih dari JS -->
                </div>
            </div>
        </main>
        
        <!-- Halaman Pemilih -->
        <main id="halaman-pemilih" class="page">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold">Pilih Calon Ketua OSIS Pilihanmu!</h2>
                <p id="welcome-voter-message" class="text-gray-700 text-lg my-4"></p>
                <p class="text-gray-600">Pemilihan akan berakhir pada: <strong id="election-end-time-voter" class="text-red-500"></strong></p>
            </div>
            <div id="voter-candidate-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Calon dari JS -->
            </div>
        </main>

        <!-- Halaman Tunggu -->
        <main id="halaman-tunggu" class="page">
             <div class="bg-white p-8 rounded-xl shadow-lg max-w-lg mx-auto text-center">
                <h2 class="text-2xl font-bold text-yellow-500 mb-4">Pemilihan Belum Dibuka atau Sudah Ditutup</h2>
                <p class="text-gray-600 mb-2">Waktu pemilihan yang telah ditetapkan:</p>
                <p id="wait-time-info" class="font-semibold text-blue-600"></p>
                <p class="mt-6 text-gray-500">Silakan kembali lagi saat waktu pemilihan sudah dimulai atau lihat hasil setelah pemilihan selesai.</p>
                 <button id="view-results-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Lihat Hasil Akhir</button>
            </div>
        </main>

        <!-- Halaman Hasil -->
        <main id="halaman-hasil" class="page">
             <div class="bg-white p-8 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Hasil Akhir Pemilihan</h2>
                    <button id="back-to-login-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">Kembali ke Login</button>
                </div>
                <div id="results-container" class="space-y-4">
                    <!-- Hasil dari JS -->
                </div>
            </div>
        </main>

        <!-- Halaman Terima Kasih -->
        <main id="halaman-terima-kasih" class="page">
            <div class="bg-white p-8 rounded-xl shadow-lg max-w-lg mx-auto text-center">
                <svg class="w-16 h-16 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h2 class="text-2xl font-bold text-green-600 mt-4 mb-2">Terima Kasih!</h2>
                <p class="text-gray-600">Suara Anda telah berhasil direkam. Partisipasi Anda sangat berarti untuk kemajuan sekolah kita.</p>
                <button id="view-results-after-vote-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Lihat Hasil Sementara</button>
            </div>
        </main>

    </div>

    <!-- Cropper.js Modal -->
    <div id="crop-modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-[100] p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg flex flex-col">
            <h3 class="text-xl font-bold mb-4">Sesuaikan Foto Kandidat</h3>
            <div class="mb-4 img-container-cropper">
                <img id="image-to-crop" class="max-w-full" src="" alt="Gambar untuk dipotong">
            </div>
            <div class="flex justify-end space-x-4 mt-auto">
                <button id="cancel-crop-btn" type="button" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Batal</button>
                <button id="crop-and-save-btn" type="button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Potong & Simpan</button>
            </div>
        </div>
    </div>

    <!-- Cropper.js Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script type="module">
        // Import fungsi Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, runTransaction, query, getDocs, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBhLIvfErc0oDs2Fd3Ojqxstq7cxoQqDck",
            authDomain: "osis-a58ba.firebaseapp.com",
            projectId: "osis-a58ba",
            storageBucket: "osis-a58ba.firebasestorage.app",
            messagingSenderId: "459759642871",
            appId: "1:459759642871:web:19481954e75ae15c408bf2"
        };
        
        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // === State Management ===
        let currentUser = null;
        let electionSettings = { startTime: null, endTime: null };
        const ADMIN_CODE = "admin";
        let cropper = null;
        let croppedImageDataUrl = null; // Menyimpan data gambar yang sudah di-crop

        // === DOM Elements ===
        const pages = document.querySelectorAll('.page');
        const loginForm = document.getElementById('login-form');
        const loginIdInput = document.getElementById('login-id');
        const loadingIndicator = document.getElementById('loading-indicator');
        const candidateForm = document.getElementById('candidate-form');
        const electionTimeForm = document.getElementById('election-time-form');
        const voterUploadForm = document.getElementById('voter-upload-form');
        const csvFileInput = document.getElementById('csv-file');
        const clearVotersBtn = document.getElementById('clear-voters-btn');
        const cropModal = document.getElementById('crop-modal-container');
        const imageToCrop = document.getElementById('image-to-crop');
        const cropAndSaveBtn = document.getElementById('crop-and-save-btn');
        const cancelCropBtn = document.getElementById('cancel-crop-btn');
        const photoPreview = document.getElementById('photo-preview');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        
        // === Helper Functions ===
        const showPage = (pageId) => {
            pages.forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        };

        const showLoading = (isLoading) => {
            loadingIndicator.classList.toggle('hidden', !isLoading);
        };

        const showAlert = (title, text, icon) => {
            Swal.fire({ title, text, icon, confirmButtonColor: '#3B82F6' });
        };
        
        const formatDate = (date) => {
             if (!date) return 'Belum diatur';
             return new Date(date).toLocaleString('id-ID', {
                dateStyle: 'full',
                timeStyle: 'short'
            });
        };

        // === Firebase Logic ===
        
        // Listener untuk pengaturan pemilihan
        const listenToElectionSettings = () => {
            const configRef = doc(db, 'config', 'election');
            onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    electionSettings.startTime = data.startTime?.toDate();
                    electionSettings.endTime = data.endTime?.toDate();
                } else {
                    electionSettings.startTime = null;
                    electionSettings.endTime = null;
                }
                updateElectionTimeDisplay();
            });
        };

        // Memeriksa status pemilihan
        const checkElectionStatus = () => {
            const now = new Date();
            if (!electionSettings.startTime || !electionSettings.endTime) {
                return 'NOT_CONFIGURED';
            }
            if (now < electionSettings.startTime) {
                return 'NOT_STARTED';
            }
            if (now > electionSettings.endTime) {
                return 'ENDED';
            }
            return 'ACTIVE';
        };

        const renderAdminCandidatesAndResults = () => {
            const candidatesCollection = collection(db, 'candidates');
            onSnapshot(query(candidatesCollection), (snapshot) => {
                const list = document.getElementById('admin-candidate-list');
                list.innerHTML = '';
                if (snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-500 col-span-full text-center">Belum ada kandidat yang ditambahkan.</p>';
                    return;
                }
                snapshot.forEach(docSnap => {
                    const candidate = { id: docSnap.id, ...docSnap.data() };
                    const totalVotes = candidate.votes || 0;
                    const card = `
                        <div class="bg-gray-50 p-4 rounded-lg shadow-md border">
                            <img src="${candidate.photoBase64}" alt="${candidate.name}" class="w-full aspect-square object-cover rounded-md mb-4">
                            <h4 class="font-bold text-lg">${candidate.name}</h4>
                            <p class="font-bold text-2xl text-blue-600 my-2">${totalVotes} Suara</p>
                            <div class="flex space-x-2 mt-4">
                                <button data-id="${candidate.id}" class="edit-btn flex-1 bg-yellow-500 text-white text-sm font-bold py-2 px-3 rounded hover:bg-yellow-600">Edit</button>
                                <button data-id="${candidate.id}" class="delete-btn flex-1 bg-red-500 text-white text-sm font-bold py-2 px-3 rounded hover:bg-red-600">Hapus</button>
                            </div>
                        </div>
                    `;
                    list.innerHTML += card;
                });
            });
        };
        
        const renderVoterStatus = async () => {
            const statsContainer = document.getElementById('voter-stats');
            const listContainer = document.getElementById('voter-status-list');
            statsContainer.innerHTML = ''; // Clear previous
            listContainer.innerHTML = '<p class="text-center text-gray-500">Memuat data pemilih...</p>'; // Loading state

            try {
                const [allowedVotersSnap, votersSnap] = await Promise.all([
                    getDocs(collection(db, 'allowedVoters')),
                    getDocs(collection(db, 'voters'))
                ]);

                const votedSet = new Set();
                votersSnap.forEach(doc => {
                    if (doc.data().hasVoted) {
                        votedSet.add(doc.id);
                    }
                });

                const totalAllowedVoters = allowedVotersSnap.size;
                const votedCount = votedSet.size;
                const participation = totalAllowedVoters > 0 ? ((votedCount / totalAllowedVoters) * 100).toFixed(1) : 0;
                
                // Render stats
                statsContainer.innerHTML = `
                    <div><p class="text-gray-500 text-sm md:text-base">Total Pemilih</p><p class="text-2xl font-bold">${totalAllowedVoters}</p></div>
                    <div><p class="text-gray-500 text-sm md:text-base">Sudah Memilih</p><p class="text-2xl font-bold text-green-600">${votedCount}</p></div>
                    <div><p class="text-gray-500 text-sm md:text-base">Partisipasi</p><p class="text-2xl font-bold text-blue-600">${participation}%</p></div>
                `;

                // Render list
                listContainer.innerHTML = '';
                if (totalAllowedVoters === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500">Daftar pemilih belum diunggah.</p>';
                    return;
                }

                let voterListHtml = '';
                const sortedAllowedVoters = [];
                 allowedVotersSnap.forEach(doc => sortedAllowedVoters.push({id: doc.id, ...doc.data()}));
                 sortedAllowedVoters.sort((a, b) => a.id.localeCompare(b.id)); // Sort by NIS

                sortedAllowedVoters.forEach(voter => {
                    const hasVoted = votedSet.has(voter.id);
                    voterListHtml += `
                        <div class="flex justify-between items-center p-3 rounded-lg ${hasVoted ? 'bg-green-50' : 'bg-gray-50'}">
                            <span class="font-medium text-gray-700">${voter.id} - ${voter.nama}</span>
                            ${hasVoted 
                                ? `<span class="flex items-center text-xs md:text-sm font-semibold text-green-700 bg-green-200 px-3 py-1 rounded-full">
                                    <svg class="w-4 h-4 mr-1 hidden md:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    Sudah Memilih
                                   </span>` 
                                : `<span class="text-xs md:text-sm font-semibold text-gray-500 bg-gray-200 px-3 py-1 rounded-full">Belum Memilih</span>`
                            }
                        </div>
                    `;
                });
                listContainer.innerHTML = voterListHtml;

            } catch (error) {
                console.error("Error rendering voter status:", error);
                listContainer.innerHTML = '<p class="text-center text-red-500">Gagal memuat data.</p>';
            }
        };

        const renderVoterCandidates = async () => {
            const list = document.getElementById('voter-candidate-list');
            list.innerHTML = '';
            try {
                const snapshot = await getDocs(query(collection(db, 'candidates')));
                 if (snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-500 col-span-full text-center">Belum ada kandidat yang tersedia.</p>';
                    return;
                }
                snapshot.forEach(docSnap => {
                    const candidate = { id: docSnap.id, ...docSnap.data() };
                    const card = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden candidate-card">
                        <img src="${candidate.photoBase64}" alt="${candidate.name}" class="w-full aspect-square object-cover">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold mb-2">${candidate.name}</h3>
                            <div class="mb-4">
                                <h4 class="font-semibold text-blue-600">Visi:</h4>
                                <p class="text-gray-600 text-sm">${candidate.vision}</p>
                            </div>
                            <div class="mb-6">
                                <h4 class="font-semibold text-blue-600">Misi:</h4>
                                <p class="text-gray-600 text-sm">${candidate.mission}</p>
                            </div>
                            <button data-id="${candidate.id}" data-name="${candidate.name}" class="vote-btn w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300">
                                Pilih ${candidate.name}
                            </button>
                        </div>
                    </div>
                    `;
                    list.innerHTML += card;
                });
            } catch (error) {
                console.error("Error fetching candidates: ", error);
                showAlert('Error', 'Gagal memuat kandidat.', 'error');
            }
        };

        const renderResults = async (containerId) => {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            showLoading(true);
            try {
                const snapshot = await getDocs(query(collection(db, 'candidates')));
                let candidates = [];
                let totalVotes = 0;
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    candidates.push({ id: docSnap.id, ...data });
                    totalVotes += (data.votes || 0);
                });
                
                candidates.sort((a, b) => (b.votes || 0) - (a.votes || 0));

                if (candidates.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center">Belum ada hasil untuk ditampilkan.</p>';
                    showLoading(false);
                    return;
                }
                
                candidates.forEach((candidate, index) => {
                    const votes = candidate.votes || 0;
                    const percentage = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(1) : 0;
                    const isWinner = index === 0 && votes > 0;
                    const resultBar = `
                    <div class="p-4 rounded-lg ${isWinner ? 'bg-green-50 border-2 border-green-400' : 'bg-gray-50 border'}">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center">
                                <span class="font-bold text-lg ${isWinner ? 'text-green-600' : 'text-gray-800'}">${candidate.name}</span>
                                ${isWinner ? '<span class="ml-2 text-xs font-bold bg-green-200 text-green-800 px-2 py-1 rounded-full">PEMENANG</span>' : ''}
                            </div>
                            <span class="font-bold text-lg ${isWinner ? 'text-green-600' : 'text-blue-600'}">${votes} Suara (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-blue-500 h-4 rounded-full ${isWinner ? '!bg-green-500' : ''}" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                    `;
                    container.innerHTML += resultBar;
                });
                 container.innerHTML += `<p class="text-center font-bold mt-6">Total Suara Masuk: ${totalVotes}</p>`;

            } catch (error) {
                console.error("Error fetching results: ", error);
                showAlert('Error', 'Gagal memuat hasil.', 'error');
            } finally {
                showLoading(false);
            }
        };

        // === Event Listeners ===
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = loginIdInput.value.trim();
            if (!id) {
                showAlert('Input Kosong', 'Harap masukkan NIS atau Kode Admin.', 'warning');
                return;
            }

            showLoading(true);

            if (id === ADMIN_CODE) {
                currentUser = { id: 'admin', role: 'admin' };
                showPage('halaman-admin');
                renderAdminCandidatesAndResults();
                renderVoterStatus();
            } else {
                
                try {
                    const allowedVoterRef = doc(db, 'allowedVoters', id);
                    const allowedVoterSnap = await getDoc(allowedVoterRef);

                    if (!allowedVoterSnap.exists()) {
                        showAlert('NIS Tidak Terdaftar', 'NIS Anda tidak terdaftar dalam daftar pemilih yang sah.', 'error');
                        showLoading(false);
                        return;
                    }

                    const studentName = allowedVoterSnap.data().nama || 'Siswa';
                    currentUser = { id, role: 'voter', name: studentName };

                    const voterRef = doc(db, 'voters', currentUser.id);
                    const voterSnap = await getDoc(voterRef);

                    if (voterSnap.exists() && voterSnap.data().hasVoted) {
                        showAlert('Sudah Memilih', 'Anda sudah menggunakan hak suara Anda.', 'info');
                        showPage('halaman-terima-kasih');
                    } else {
                        const status = checkElectionStatus();
                        if (status === 'ACTIVE') {
                            document.getElementById('welcome-voter-message').textContent = `Selamat datang, ${currentUser.name}! Mari berperan aktif dalam kemajuan sekolah, silakan pilih sesuai dengan apa yang kamu cita-citakan dan tujuanmu.`;
                            await renderVoterCandidates();
                            showPage('halaman-pemilih');
                        } else {
                            showPage('halaman-tunggu');
                        }
                    }
                } catch (error) {
                    console.error("Login error:", error);
                    showAlert('Error', 'Terjadi kesalahan saat verifikasi data.', 'error');
                }
            }
            showLoading(false);
        });
        
        voterUploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const file = csvFileInput.files[0];

            if (!file) {
                showAlert('Tidak Ada File', 'Silakan pilih file CSV untuk diunggah.', 'warning');
                return;
            }
            showLoading(true);
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const csvText = event.target.result;
                    const lines = csvText.split(/\r?\n/).filter(line => line.trim());
                    
                    if (lines.length === 0) {
                        showAlert('File Kosong', 'File CSV tidak berisi data yang valid.', 'warning');
                        showLoading(false);
                        return;
                    }

                    const votersList = lines.map(line => {
                        const [nis, ...namaParts] = line.split(/[,;]/); // Handles both comma and semicolon
                        const nama = namaParts.join(',').trim();
                        return { nis: nis.trim(), nama };
                    }).filter(v => v.nis && v.nama);

                    if(votersList.length === 0){
                        showAlert('Format Salah', 'Pastikan format CSV adalah NIS,Nama Siswa (atau NIS;Nama Siswa) dan file tidak kosong.', 'error');
                        showLoading(false);
                        return;
                    }

                    const existingVotersSnapshot = await getDocs(collection(db, 'allowedVoters'));
                    const deleteBatch = writeBatch(db);
                    existingVotersSnapshot.forEach((doc) => {
                        deleteBatch.delete(doc.ref);
                    });
                    await deleteBatch.commit();
                    
                    const addBatch = writeBatch(db);
                    votersList.forEach(voter => {
                        const voterRef = doc(db, 'allowedVoters', voter.nis);
                        addBatch.set(voterRef, { nama: voter.nama });
                    });
                    await addBatch.commit();

                    showAlert('Sukses', `${votersList.length} pemilih berhasil diimpor. Daftar pemilih sebelumnya telah diganti.`, 'success');
                    renderVoterStatus();

                } catch (error) {
                    console.error("Error importing voters: ", error);
                    showAlert('Error', 'Terjadi kesalahan saat mengimpor data.', 'error');
                } finally {
                    showLoading(false);
                    voterUploadForm.reset();
                }
            };
            reader.readAsText(file);
        });

        clearVotersBtn.addEventListener('click', () => {
            Swal.fire({
                title: 'Reset Seluruh Data Pemilihan?',
                text: "Aksi ini akan MENGHAPUS SEMUA daftar pemilih (dari CSV) DAN data siapa saja yang sudah memilih. Jumlah suara pada kandidat JUGA akan direset ke 0. Aksi ini tidak bisa dibatalkan.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Reset Semuanya!',
                cancelButtonText: 'Batal'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading(true);
                    try {
                        const [allowedVotersSnap, votersSnap, candidatesSnap] = await Promise.all([
                            getDocs(collection(db, 'allowedVoters')),
                            getDocs(collection(db, 'voters')),
                            getDocs(collection(db, 'candidates'))
                        ]);

                        const batch = writeBatch(db);
                        allowedVotersSnap.forEach(doc => batch.delete(doc.ref));
                        votersSnap.forEach(doc => batch.delete(doc.ref));
                        candidatesSnap.forEach(doc => {
                            batch.update(doc.ref, { votes: 0 });
                        });

                        await batch.commit();
                        showAlert('Berhasil!', 'Seluruh data pemilihan (pemilih, suara, dan status) telah berhasil direset.', 'success');
                        renderVoterStatus(); 

                    } catch (error) {
                        console.error("Error resetting election data: ", error);
                        showAlert('Error!', 'Gagal mereset data pemilihan.', 'error');
                    } finally {
                        showLoading(false);
                    }
                }
            });
        });

        const exportToExcel = async () => {
            showLoading(true);
            try {
                const [allowedVotersSnap, votersSnap] = await Promise.all([
                    getDocs(collection(db, 'allowedVoters')),
                    getDocs(collection(db, 'voters'))
                ]);

                if (allowedVotersSnap.empty) {
                    showAlert('Tidak Ada Data', 'Daftar pemilih kosong, tidak ada data untuk diekspor.', 'info');
                    return;
                }

                const votedSet = new Set();
                votersSnap.forEach(doc => {
                    if (doc.data().hasVoted) {
                        votedSet.add(doc.id);
                    }
                });

                const exportData = [];
                allowedVotersSnap.forEach(doc => {
                    exportData.push({
                        'NIS': doc.id,
                        'Nama Siswa': doc.data().nama,
                        'Status': votedSet.has(doc.id) ? 'Sudah Memilih' : 'Belum Memilih'
                    });
                });
                
                exportData.sort((a, b) => a['NIS'].localeCompare(b['NIS']));

                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Partisipasi Pemilih");
                
                // Auto-fit columns
                const objectMaxLength = [];
                exportData.forEach(item => {
                    Object.keys(item).forEach((key, i) => {
                        const len = item[key] ? item[key].toString().length : 0;
                        if (!objectMaxLength[i] || objectMaxLength[i] < len) {
                            objectMaxLength[i] = len;
                        }
                    });
                });
                 worksheet["!cols"] = objectMaxLength.map(w => ({ wch: w + 2 }));


                XLSX.writeFile(workbook, "Laporan_Partisipasi_Pemilih.xlsx");

            } catch (error) {
                console.error("Error exporting to Excel:", error);
                showAlert('Error', 'Gagal mengekspor data ke Excel.', 'error');
            } finally {
                showLoading(false);
            }
        };

        exportExcelBtn.addEventListener('click', exportToExcel);


        // Event listener untuk admin
        document.getElementById('logout-btn').addEventListener('click', () => {
            currentUser = null;
            loginIdInput.value = '';
            showPage('halaman-login');
        });
        
        document.getElementById('back-to-login-btn').addEventListener('click', () => {
            currentUser = null;
            loginIdInput.value = '';
            showPage('halaman-login');
        });
        
        document.getElementById('view-results-btn').addEventListener('click', () => {
            renderResults('results-container');
            showPage('halaman-hasil');
        });
        
        document.getElementById('view-results-after-vote-btn').addEventListener('click', () => {
            renderResults('results-container');
            showPage('halaman-hasil');
        });

        electionTimeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const startTime = new Date(document.getElementById('start-time').value);
            const endTime = new Date(document.getElementById('end-time').value);

            if (isNaN(startTime.getTime()) || isNaN(endTime.getTime()) || startTime >= endTime) {
                showAlert('Input Tidak Valid', 'Waktu mulai dan selesai tidak valid.', 'error');
                return;
            }

            showLoading(true);
            try {
                const configRef = doc(db, 'config', 'election');
                await setDoc(configRef, { startTime, endTime });
                showAlert('Sukses', 'Jadwal pemilihan berhasil diperbarui.', 'success');
            } catch (error) {
                console.error("Error setting election time: ", error);
                showAlert('Error', 'Gagal menyimpan jadwal.', 'error');
            } finally {
                showLoading(false);
            }
        });

        // Event listener untuk input file foto -> Buka Cropper
        document.getElementById('candidate-photo').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) { return; }

            if (file.size > 1024 * 1024 * 2) { // 2MB limit
                showAlert('Ukuran File Terlalu Besar', 'Ukuran foto tidak boleh melebihi 2MB.', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                imageToCrop.src = event.target.result;
                cropModal.classList.remove('hidden');
                cropModal.classList.add('flex');
                
                if (cropper) { cropper.destroy(); }

                cropper = new Cropper(imageToCrop, {
                    aspectRatio: 1 / 1,
                    viewMode: 1,
                    background: false,
                });
            };
            reader.readAsDataURL(file);
        });

        cancelCropBtn.addEventListener('click', () => {
            cropModal.classList.add('hidden');
            cropModal.classList.remove('flex');
            if (cropper) { cropper.destroy(); }
            document.getElementById('candidate-photo').value = '';
        });

        cropAndSaveBtn.addEventListener('click', () => {
            if (cropper) {
                const canvas = cropper.getCroppedCanvas({
                    width: 500, height: 500, imageSmoothingQuality: 'high',
                });
                croppedImageDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                photoPreview.src = croppedImageDataUrl;
                photoPreview.classList.remove('hidden');
                
                cropModal.classList.add('hidden');
                cropModal.classList.remove('flex');
                cropper.destroy();
            }
        });

        candidateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const candidateId = document.getElementById('candidate-id').value;
            const name = document.getElementById('candidate-name').value;
            const vision = document.getElementById('candidate-vision').value;
            const mission = document.getElementById('candidate-mission').value;

            if (!name || !vision || !mission) {
                showAlert('Data Tidak Lengkap', 'Nama, visi, dan misi harus diisi.', 'warning');
                return;
            }
            
            if (!candidateId && !croppedImageDataUrl) { 
                showAlert('Foto Wajib', 'Foto kandidat harus diunggah dan dipotong.', 'warning');
                return;
            }

            showLoading(true);

            try {
                let photoBase64;
                if (croppedImageDataUrl) {
                    photoBase64 = croppedImageDataUrl;
                } else {
                    photoBase64 = photoPreview.src;
                }
                const candidateData = { name, vision, mission, photoBase64 };
                if (candidateId) {
                    const candidateRef = doc(db, 'candidates', candidateId);
                    await updateDoc(candidateRef, candidateData);
                    showAlert('Sukses', 'Data kandidat berhasil diperbarui.', 'success');
                } else {
                    candidateData.votes = 0;
                    const newCandidateRef = doc(collection(db, 'candidates'));
                    await setDoc(newCandidateRef, candidateData);
                    showAlert('Sukses', 'Kandidat baru berhasil ditambahkan.', 'success');
                }
                
                candidateForm.reset();
                photoPreview.classList.add('hidden');
                photoPreview.src = '';
                croppedImageDataUrl = null;
                document.getElementById('candidate-id').value = '';
                document.getElementById('submit-candidate-btn').textContent = 'Tambah Kandidat';
                document.getElementById('cancel-edit-btn').classList.add('hidden');

            } catch (error) {
                console.error("Error saving candidate: ", error);
                showAlert('Error', 'Gagal menyimpan data kandidat.', 'error');
            } finally {
                showLoading(false);
            }
        });

        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
             candidateForm.reset();
             photoPreview.classList.add('hidden');
             photoPreview.src = '';
             croppedImageDataUrl = null;
             document.getElementById('candidate-id').value = '';
             document.getElementById('submit-candidate-btn').textContent = 'Tambah Kandidat';
             document.getElementById('cancel-edit-btn').classList.add('hidden');
        });

        // Event delegation for dynamic buttons
        document.body.addEventListener('click', async (e) => {
            if (e.target.closest('.edit-btn')) {
                const id = e.target.closest('.edit-btn').dataset.id;
                showLoading(true);
                try {
                    const candidateRef = doc(db, 'candidates', id);
                    const docSnap = await getDoc(candidateRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('candidate-id').value = id;
                        document.getElementById('candidate-name').value = data.name;
                        document.getElementById('candidate-vision').value = data.vision;
                        document.getElementById('candidate-mission').value = data.mission;
                        photoPreview.src = data.photoBase64;
                        photoPreview.classList.remove('hidden');
                        croppedImageDataUrl = null; // Reset cropper state on edit
                        document.getElementById('submit-candidate-btn').textContent = 'Update Kandidat';
                        document.getElementById('cancel-edit-btn').classList.remove('hidden');
                        window.scrollTo({ top: candidateForm.offsetTop, behavior: 'smooth' });
                    }
                } catch(error) {
                    showAlert('Error', 'Gagal mengambil data kandidat.', 'error');
                } finally {
                    showLoading(false);
                }
            }

            if (e.target.closest('.delete-btn')) {
                const id = e.target.closest('.delete-btn').dataset.id;
                Swal.fire({
                    title: 'Anda yakin?', text: "Data kandidat akan dihapus permanen!", icon: 'warning',
                    showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Ya, hapus!', cancelButtonText: 'Batal'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        showLoading(true);
                        try {
                            await deleteDoc(doc(db, 'candidates', id));
                            showAlert('Dihapus!', 'Data kandidat telah dihapus.', 'success');
                        } catch (error) {
                            showAlert('Error!', 'Gagal menghapus data.', 'error');
                        } finally {
                            showLoading(false);
                        }
                    }
                })
            }

            if (e.target.closest('.vote-btn')) {
                const button = e.target.closest('.vote-btn');
                const id = button.dataset.id;
                const name = button.dataset.name;
                Swal.fire({
                    title: `Pilih ${name}?`, text: "Anda tidak dapat mengubah pilihan Anda setelah ini.", icon: 'question',
                    showCancelButton: true, confirmButtonColor: '#3085d6', cancelButtonColor: '#d33',
                    confirmButtonText: 'Ya, saya yakin!', cancelButtonText: 'Batal'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                       showLoading(true);
                        try {
                            const candidateRef = doc(db, "candidates", id);
                            const voterRef = doc(db, "voters", currentUser.id);
                            await runTransaction(db, async (transaction) => {
                                const voterDoc = await transaction.get(voterRef);
                                if (voterDoc.exists() && voterDoc.data().hasVoted) {
                                    throw "SUDAH_MEMILIH";
                                }
                                const candidateDoc = await transaction.get(candidateRef);
                                if (!candidateDoc.exists()) {
                                    throw "KANDIDAT_TIDAK_DITEMUKAN";
                                }
                                const newVoteCount = (candidateDoc.data().votes || 0) + 1;
                                transaction.update(candidateRef, { votes: newVoteCount });
                                transaction.set(voterRef, { hasVoted: true, votedAt: new Date() });
                            });
                            showPage('halaman-terima-kasih');
                        } catch (error) {
                            console.error("Vote Error: ", error);
                             if(error === "SUDAH_MEMILIH"){
                                showAlert('Gagal', 'Anda sudah pernah memilih sebelumnya.', 'error');
                                showPage('halaman-terima-kasih');
                             } else {
                                showAlert('Gagal', 'Terjadi kesalahan saat menyimpan suara.', 'error');
                             }
                        } finally {
                            showLoading(false);
                        }
                    }
                });
            }
        });
        
        function updateElectionTimeDisplay() {
            const timeInfoAdmin = document.getElementById('current-election-time');
            const timeInfoVoter = document.getElementById('election-end-time-voter');
            const waitTimeInfo = document.getElementById('wait-time-info');
            if (electionSettings.startTime && electionSettings.endTime) {
                const start = formatDate(electionSettings.startTime);
                const end = formatDate(electionSettings.endTime);
                const infoText = `Mulai: <strong>${start}</strong><br>Selesai: <strong>${end}</strong>`;
                timeInfoAdmin.innerHTML = infoText;
                timeInfoVoter.textContent = end;
                waitTimeInfo.innerHTML = infoText;
            } else {
                const notSetText = 'Waktu pemilihan belum diatur.';
                timeInfoAdmin.textContent = notSetText;
                timeInfoVoter.textContent = '-';
                waitTimeInfo.textContent = notSetText;
            }
        }

        const startApp = () => {
            listenToElectionSettings();
            showPage('halaman-login');
        };
        startApp();
    </script>
</body>
</html>

